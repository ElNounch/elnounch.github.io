<!doctype html>
<html lang="fr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
	<title>GTNH quests dependencies</title>
	<style>
		body {
			height: 100%;
			width: 100%;
			overflow: hidden;
			margin: 0px;
		}

		#selectorbar {
			position: fixed;
			bottom: 0;
			right: 0;
			border: 3px solid #73AD21;
			width: 25cm;
			z-index: 1;
		}

		#graph {
			height: 100%;
			width: 100%;
			position: fixed;
			top: 0;
			right: 0;
			z-index: -999;
		}
	</style>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
	<script src="https://cdn.jsdelivr.net/npm/d3@5/dist/d3.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm@1/dist/index.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-graphviz@3/build/d3-graphviz.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
<div id="selectorbar">
<select id="quest-select"></select>
<button onclick="copyDOTtoClipboard()">&#x1f4cb;</button>
</div>
<div id="graph" height="100%"></div>
<script>
"use strict";

	var branchCurrent
	var questCurrent
	var quests
	var questLines
	var questSelector
	var dotContent
	var alreadyDrawn
	var questlineUsedMembers

	function copyDOTtoClipboard() {
		navigator.clipboard.writeText(dotContent)
	}

	function cleanString(str) {
		return str.replace(/\xA7./g, '')
	}

	function updateURL(replace) {
		var title = 'Dependencies of ' + (((quests !== undefined) && quests.hasOwnProperty(questCurrent)) ? ('"' + quests[questCurrent].name + '" (#' + quests[questCurrent].id + ')') : '???') + ((branchCurrent !== "master") ? (' on version ' + branchCurrent) : '')
		window.document.title = title
		if (replace) {
			history.replaceState({
				branch: branchCurrent,
				questID: questCurrent,
			}, title, '?branch=' + branchCurrent + '&questID=' + questCurrent);
		} else {
			history.pushState({
				branch: branchCurrent,
				questID: questCurrent,
			}, title, '?branch=' + branchCurrent + '&questID=' + questCurrent);
		}

		if ((quests !== undefined) && (Object.keys(quests).length != 0)) {
			graphQuest()
		}
		if (questSelector.getValue(true) !== [questCurrent]) {
			questSelector.setChoiceByValue([questCurrent])
		}
	}

	function quote_string(str) {
		return str.replaceAll("\"", "\\\"").replaceAll("\'", "\\\'")
	}
	function quote_newlines(str) {
		return str.replaceAll("\n", "\\n")
	}
	function addContent(str) {
		dotContent = dotContent + str;
	}
	function addContentNl(str) {
		addContent(str + "\n");
	}

	function graphQuest() {
		alreadyDrawn = new Set()
		questlineUsedMembers = new Map()
		dotContent = ""

		addContentNl("digraph {")
		addContentNl("\trankdir=BT")
		addContentNl("\tnode [shape=none, margin=0]")
		graphQuestRecurse(questCurrent, quests[questCurrent].questLine)
		addContentNl("\tlabelloc = b")
		addContentNl("\tfontcolor = blue")
		for (var [questLineId, used] of questlineUsedMembers) {
			var details = questLines[questLineId]
			addContentNl("\tsubgraph cluster_" + questLineId + " {")
			addContentNl("\t\tlabel=\"" + quote_string(details.name) + "\"")
			for (var questId of used) {
				addContentNl("\t\t" + questId)
			}
			addContentNl("\t}")
		}
		addContentNl("}")

		d3.select("#graph").graphviz().renderDot(dotContent)
	}
	

	function graphQuestRecurse(questId,initialQuestLine) {
		var details = quests[questId]
		var currentIsMain = questLines[details.questLine].isMain

		if (!questlineUsedMembers.has(details.questLine)) {
			questlineUsedMembers.set(details.questLine, new Set())
		}
		questlineUsedMembers.get(details.questLine).add(questId)
		
		if (!alreadyDrawn.has(questId)) {
			alreadyDrawn.add(questId)
			addContentNl("\t" + questId + " [label=\"" + quote_string(details.name) + "\" tooltip=\"" + quote_newlines(quote_string(cleanString(details.description))) + "\"]")
			if (!currentIsMain || (details.questLine == initialQuestLine)) {
				details.preRequirements.forEach( (prevQuest) => {
					addContentNl("\t" + prevQuest + " -> " + questId)
				})
				details.preRequirements.forEach( (prevQuest) => {
					graphQuestRecurse(prevQuest,initialQuestLine)
				})
			}
		}
	}

	function ingestQuestsDef(def) {
		if (def['format:8'] === "2.0.0") {
			quests = {}
			questLines = {}
			var selector_questlist = {}
			var lostandfound_questline = 'LostAndFound';

			for (const idx in def['questDatabase:9']) {
				var details = def['questDatabase:9'][idx];
				var questId = 'quest_' + details['questID:3']

				quests[questId] = {
					id: details['questID:3'],
					name: cleanString(details['properties:10']['betterquesting:10']['name:8']),
					isMain: (('isMain:1' in details['properties:10']['betterquesting:10']) && (details['properties:10']['betterquesting:10']['isMain:1'] === 1)),
					preRequirements: [],
					description: ('desc:8' in details['properties:10']['betterquesting:10'] ? details['properties:10']['betterquesting:10']['desc:8'] : ""),
					questLine: lostandfound_questline,
				}

				var preRequisites =  details['preRequisites:11']
				for (const idxPreRequisites in preRequisites) {
					quests[questId].preRequirements.push('quest_' + preRequisites[idxPreRequisites])
				}
			}

			for (const idx in def['questLines:9']) {
				var detailsQuestLine = def['questLines:9'][idx];
				var questLineId = 'questline_' + detailsQuestLine['lineID:3']
				questLines[questLineId] = {
					name: cleanString(detailsQuestLine['properties:10']['betterquesting:10']['name:8']),
					isMain: cleanString(detailsQuestLine['properties:10']['betterquesting:10']['name:8']).startsWith('Tier '),
				}

				selector_questlist[questLineId] = {
					label: questLines[questLineId].name,
					choices: [],
				}

				for (const idxMember in detailsQuestLine['quests:9']) {
					var questId = 'quest_' + detailsQuestLine['quests:9'][idxMember]['id:3']
					quests[questId].questLine = questLineId;
					selector_questlist[questLineId].choices.push({
						id: detailsQuestLine['quests:9'][idxMember]['id:3'],
						value: questId,
						label: quests[questId].name,
						customProperties: {
							description: quests[questId].description,
						},
					})
				}
			}
			
			// Fallback questline
			questLines[lostandfound_questline] = {
				name: "Lost & Hidden quests",
				isMain: true,
			}
			selector_questlist[lostandfound_questline] = {
				label: questLines[lostandfound_questline].name,
				choices: [],
			}
			for (const questId in quests) {
				if (quests[questId].questLine == lostandfound_questline) {
					selector_questlist[lostandfound_questline].choices.push({
						value: questId,
						label: quests[questId].name,
						customProperties: {
							description: quests[questId].description,
						},
					})
				}
			}
			questSelector.setChoices(Object.values(selector_questlist), 'value', 'label', true)
			updateURL(true);
		} else {
			console.log("Unhandled BetterQuest definitions format")
		}
	}

	function loadDefinitionVersion(ver) {
		var httpRequest = new XMLHttpRequest();
		httpRequest.responseType = 'json'
		httpRequest.onreadystatechange = function() {
		  if (httpRequest.readyState === XMLHttpRequest.DONE) {
			if (httpRequest.status === 200) {
			  ingestQuestsDef(httpRequest.response)
			} else {
				console.log("Error " + httpRequest.status + " while downloading quests definitions");
			}
		  }
		};
		httpRequest.open('GET', 'https://cdn.jsdelivr.net/gh/GTNewHorizons/GT-New-Horizons-Modpack@' + ver + '/config/betterquesting/DefaultQuests.json', true)
		httpRequest.send()
	}
	
	function getParam(name) {
		return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(name).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
	}

    document.addEventListener('DOMContentLoaded', function() {
		questSelector = new Choices('#quest-select', {
			maxItemCount:	1,
			shouldSort:		false,
			searchFields:	['label', 'id', 'customProperties.description'],
			placeholderValue: "???",
			searchPlaceholderValue: "Select quest",
			fuseOptions: {
				ignoreLocation: true,
			},
		});
		questSelector.passedElement.element.addEventListener('change', (event) => {
			questCurrent = event.detail.value
			updateURL()
		});

		branchCurrent = getParam('branch') || 'master'
		questCurrent = getParam('questID') || 'quest_0'
		loadDefinitionVersion(branchCurrent)
	})
</script>
</body>
</html>
